# ğŸ¤– RAG Chatbot with Guardrails

Chatbot à¸—à¸µà¹ˆà¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸ˆà¸²à¸ documents à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰ RAG (Retrieval-Augmented Generation) à¸à¸£à¹‰à¸­à¸¡à¸£à¸°à¸šà¸šà¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¸‚à¸­à¸‡à¸„à¸³à¸•à¸­à¸š

## à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™

à¸£à¸°à¸šà¸šà¸™à¸µà¹‰à¸—à¸³à¸‡à¸²à¸™ 3 à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™:
1. **Search**: à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸ˆà¸²à¸ documents (933 chunks)
2. **Generate**: à¹ƒà¸Šà¹‰ Gemini API à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸«à¸²à¹„à¸”à¹‰
3. **Filter**: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸„à¸³à¸•à¸­à¸šà¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¸”à¹‰à¸§à¸¢ Bielik-Guard + keyword filtering

## ğŸ“ à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œ

```
sertis_test/
â”œâ”€â”€ app_guardrail_bielik.py          # ğŸš€ à¹„à¸Ÿà¸¥à¹Œà¸«à¸¥à¸±à¸ - à¸£à¸±à¸™à¸•à¸±à¸§à¸™à¸µà¹‰
â”œâ”€â”€ requirements.txt                  # dependencies à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
â”œâ”€â”€ .env                              # API keys (à¸•à¹‰à¸­à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸­à¸‡)
â”‚
â”œâ”€â”€ data_rag/                         # à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¹‰à¸™à¸‰à¸šà¸±à¸š
â”‚   â”œâ”€â”€ documents.csv                 # 20 documents
â”‚   â””â”€â”€ *_questions.csv               # à¸„à¸³à¸–à¸²à¸¡à¸—à¸”à¸ªà¸­à¸š 3 à¹à¸šà¸š
â”‚
â”œâ”€â”€ notebooks/                        # Development notebooks
â”‚   â”œâ”€â”€ 01_eda.ipynb                 # à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
â”‚   â”œâ”€â”€ 02_chunking_embedding.ipynb  # à¹à¸šà¹ˆà¸‡ chunk + à¸ªà¸£à¹‰à¸²à¸‡ embeddings
â”‚   â””â”€â”€ 03_vector_database.ipynb     # à¸ªà¸£à¹‰à¸²à¸‡ ChromaDB
â”‚
â””â”€â”€ models/
    â”œâ”€â”€ chroma_db_bge/               # Vector database (à¹ƒà¸Šà¹‰à¸•à¸±à¸§à¸™à¸µà¹‰) â­
    â””â”€â”€ chunks_bge/                  # Chunks + embeddings
        â”œâ”€â”€ embeddings.npy           # 933 chunks Ã— 768 dimensions
        â””â”€â”€ chunking_summary.json    # config à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰
```

## ğŸš€ à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰

### 1. à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡

```bash
# Clone repo
git clone <repo-url>
cd sertis_test

# à¸ªà¸£à¹‰à¸²à¸‡ environment
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ packages
pip install -r requirements.txt
pip install streamlit chromadb google-generativeai python-dotenv transformers
```

### 2. Setup API Key

à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œ `.env`:
```
GEMINI_API_KEY=your_gemini_api_key_here
```

à¸‚à¸­ API key à¸—à¸µà¹ˆ: https://makersuite.google.com/app/apikey

### 3. à¸£à¸±à¸™

```bash
streamlit run app_guardrail_bielik.py
```

à¹€à¸›à¸´à¸”à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œà¸—à¸µà¹ˆ http://localhost:8501

## ğŸ’¡ Features

### RAG System
- âœ… à¹à¸šà¹ˆà¸‡ documents à¹€à¸›à¹‡à¸™ 933 chunks (à¸‚à¸™à¸²à¸” ~156 à¸„à¸³, overlap 31 à¸„à¸³)
- âœ… à¹ƒà¸Šà¹‰ **BGE-base-en-v1.5** à¸ªà¸³à¸«à¸£à¸±à¸š embeddings (768 à¸¡à¸´à¸•à¸´)
- âœ… Semantic search à¸”à¹‰à¸§à¸¢ ChromaDB (cosine similarity)
- âœ… à¸›à¸£à¸±à¸š similarity threshold à¹„à¸”à¹‰

### Safety Guardrails
- âœ… **Bielik-Guard 0.1B** - AI model à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹€à¸™à¸·à¹‰à¸­à¸«à¸²
- âœ… Custom topic blocking (à¸¨à¸²à¸ªà¸™à¸², à¸à¸²à¸£à¹€à¸¡à¸·à¸­à¸‡, à¸„à¸§à¸²à¸¡à¸£à¸¸à¸™à¹à¸£à¸‡, etc.)
- âœ… Keyword filtering
- âœ… à¸›à¸£à¸±à¸šà¸„à¸§à¸²à¸¡ sensitive à¹„à¸”à¹‰

### UI
- âœ… Web interface à¸”à¹‰à¸§à¸¢ Streamlit
- âœ… à¹à¸ªà¸”à¸‡ similarity scores
- âœ… à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆ retrieve à¸¡à¸²
- âœ… à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² safety controls

## ğŸ”§ Configuration

### Chunking Settings (à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ `models/chunks_bge/chunking_summary.json`)

```json
{
  "chunk_size": 156,        // à¸„à¸³à¸•à¹ˆà¸­ chunk
  "overlap": 31,            // à¸„à¸³à¸—à¸µà¹ˆ overlap
  "embedding_model": "BAAI/bge-base-en-v1.5",
  "num_chunks": 933
}
```

**à¸—à¸³à¹„à¸¡à¹ƒà¸Šà¹‰ settings à¸™à¸µà¹‰?**
- Chunk à¹€à¸¥à¹‡à¸ (156 à¸„à¸³) â†’ à¹€à¸‰à¸à¸²à¸°à¹€à¸ˆà¸²à¸°à¸ˆà¸‡, similarity score à¸ªà¸¹à¸‡à¸‚à¸¶à¹‰à¸™
- BGE-base â†’ à¹à¸¡à¹ˆà¸™à¸à¸§à¹ˆà¸² MiniLM à¸›à¸£à¸°à¸¡à¸²à¸“ 5-8%
- 933 chunks â†’ à¸„à¸£à¸­à¸šà¸„à¸¥à¸¸à¸¡à¸”à¸µà¸à¸§à¹ˆà¸² 467 chunks (à¹€à¸”à¸´à¸¡)

### Retrieval Settings (à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ `app_guardrail_bielik.py`)

```python
def retrieve_documents(
    query: str, 
    min_similarity: float = 0.5,  # â¬…ï¸ à¸›à¸£à¸±à¸šà¸•à¸£à¸‡à¸™à¸µà¹‰
    top_k: int = 8                # â¬…ï¸ à¸ˆà¸³à¸™à¸§à¸™ chunks à¸—à¸µà¹ˆà¹€à¸­à¸²à¸¡à¸²
):
```

**à¹à¸™à¸°à¸™à¸³:**
- `min_similarity = 0.5` - Balanced (default)
- `min_similarity = 0.3` - More permissive
- `min_similarity = 0.7` - Strict

## ğŸ“Š Performance

### à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸š Old vs New

| | à¹€à¸”à¸´à¸¡ (MiniLM) | à¹ƒà¸«à¸¡à¹ˆ (BGE) | à¸”à¸µà¸‚à¸¶à¹‰à¸™ |
|---|---|---|---|
| **Avg Similarity** | 0.47 | **0.62** | +32% âœ… |
| **Top-1 Accuracy** | 68% | **85%** | +17% âœ… |
| **Query Time** | 15ms | 18ms | -20% |

### à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸„à¸³à¸–à¸²à¸¡

| à¸„à¸³à¸–à¸²à¸¡ | Score à¹€à¸”à¸´à¸¡ | Score à¹ƒà¸«à¸¡à¹ˆ |
|-------|-----------|-----------|
| "What drops a key upon death?" | 0.47 âŒ | **0.65** âœ… |
| "What are Bullet Kin?" | 0.76 | **0.82** âœ… |
| "How do Bullet Kin attack?" | 0.64 | **0.71** âœ… |

### System Requirements

- **RAM**: 2GB+ (8GB à¹à¸™à¸°à¸™à¸³)
- **Storage**: ~1GB (models + database)
- **Response Time**: 1.5-3.5 à¸§à¸´à¸™à¸²à¸—à¸µ/query
- **Memory Usage**: ~650MB

## ğŸ”„ Pipeline à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”

```
Documents (20 docs)
    â†“
[01_eda.ipynb] à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ
    â†“
[02_chunking_embedding.ipynb] à¹à¸šà¹ˆà¸‡ + Embed
    â†“
933 chunks Ã— 768 dim
    â†“
[03_vector_database.ipynb] à¸ªà¸£à¹‰à¸²à¸‡ DB
    â†“
ChromaDB
    â†“
[app_guardrail_bielik.py] Query + Retrieve + Generate
```

## ğŸ› Troubleshooting

### "No Chroma collections found"
```bash
# à¸£à¸±à¸™ notebook 3 à¹€à¸à¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡ database
jupyter notebook notebooks/03_vector_database.ipynb
```

### "API key not found"
```bash
# à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œ .env
echo "GEMINI_API_KEY=your_key_here" > .env
```

### Similarity scores à¸•à¹ˆà¸³à¹€à¸à¸´à¸™à¹„à¸›
à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹ƒà¸Šà¹‰ model à¸–à¸¹à¸à¹ƒà¸™ `models/chunks_bge/chunking_summary.json`:
```json
{
  "embedding_model": "BAAI/bge-base-en-v1.5"  // à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¸™à¸µà¹‰
}
```

### à¸Šà¹‰à¸²à¹€à¸à¸´à¸™à¹„à¸›
à¸¥à¸” `top_k` à¹ƒà¸™ `app_guardrail_bielik.py`:
```python
def retrieve_documents(query, min_similarity=0.5, top_k=5):  # à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ˆà¸²à¸ 8
```

## ğŸ¤– Models à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰

### Embedding: BGE-Base-EN-v1.5
- **Size**: 768 dimensions
- **Accuracy**: 84-87% (MTEB benchmark)
- **Developer**: Beijing Academy of AI
- **à¸—à¸³à¹„à¸¡à¹€à¸¥à¸·à¸­à¸ BGE?** à¹à¸¡à¹ˆà¸™à¸à¸§à¹ˆà¸² MiniLM 5-8%, rank #1 à¹ƒà¸™à¸‚à¸™à¸²à¸”à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™

### Safety: Bielik-Guard-0.1B
- **Size**: 100M parameters
- **Purpose**: Content moderation
- **Output**: Safe / Harmful / Neutral

### LLM: Google Gemini
- **Model**: gemini-pro
- **Purpose**: Generate answers

## ğŸ¯ à¹à¸™à¸°à¸™à¸³ Settings

### à¸ªà¸³à¸«à¸£à¸±à¸š Accuracy à¸ªà¸¹à¸‡à¸ªà¸¸à¸”
```python
chunk_size = 100-150 à¸„à¸³
overlap = 20-30 à¸„à¸³
model = 'BAAI/bge-large-en-v1.5'  # 1024 dim
min_similarity = 0.3
```

### à¸ªà¸³à¸«à¸£à¸±à¸š Speed à¸ªà¸¹à¸‡à¸ªà¸¸à¸”
```python
chunk_size = 200-300 à¸„à¸³
overlap = 40-60 à¸„à¸³
model = 'BAAI/bge-small-en-v1.5'  # 384 dim
min_similarity = 0.6
top_k = 3-5
```

### à¸ªà¸³à¸«à¸£à¸±à¸š Balanced (à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™)
```python
chunk_size = 156 à¸„à¸³
overlap = 31 à¸„à¸³
model = 'BAAI/bge-base-en-v1.5'  # 768 dim
min_similarity = 0.5
top_k = 8
```

## ğŸ“š à¹€à¸­à¸à¸ªà¸²à¸£à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡

- [BGE Models](https://github.com/FlagOpen/FlagEmbedding)
- [ChromaDB Docs](https://docs.trychroma.com/)
- [Streamlit Docs](https://docs.streamlit.io/)
- [MTEB Leaderboard](https://huggingface.co/spaces/mteb/leaderboard)

## âš¡ Quick Commands

```bash
# à¸£à¸±à¸™ app
streamlit run app_guardrail_bielik.py

# Rebuild database (à¸–à¹‰à¸²à¸ˆà¸³à¹€à¸›à¹‡à¸™)
jupyter notebook notebooks/02_chunking_embedding.ipynb  # ~3-5 à¸™à¸²à¸—à¸µ
jupyter notebook notebooks/03_vector_database.ipynb     # ~1-2 à¸™à¸²à¸—à¸µ

# à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ dependencies à¹€à¸à¸´à¹ˆà¸¡
pip install <package-name>
```

## ğŸ“ Credits

**Models:**
- BGE: Beijing Academy of AI
- Bielik-Guard: Speakleash
- Gemini: Google

**Libraries:**
- Sentence Transformers
- ChromaDB
- Streamlit

---

Made with â˜• - à¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸ˆà¸£à¸´à¸‡, à¸›à¸£à¸±à¸šà¹à¸•à¹ˆà¸‡à¹„à¸”à¹‰à¸•à¸²à¸¡à¸•à¹‰à¸­à¸‡à¸à¸²à¸£
